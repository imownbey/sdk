# Quick Start Guide

This guide will help you get started with the Pierre Git Storage Python SDK.

## Installation

```bash
# Using uv (recommended)
uv add pierre-storage

# Or using pip
pip install pierre-storage
```

## Your First Repository

Here's a minimal example to create a repository and make your first commit:

```python
import asyncio
from pierre_storage import GitStorage

async def main():
    # Initialize the client
    storage = GitStorage({
        "name": "your-name",
        "key": """-----BEGIN PRIVATE KEY-----
        Your private key here
        -----END PRIVATE KEY-----""",
    })

    # Create a repository
    repo = await storage.create_repo()
    print(f"Created repository: {repo.id}")

    # Get the Git remote URL
    url = await repo.get_remote_url()
    print(f"Git URL: {url}")

    # Create your first commit
    result = await (
        repo.create_commit({
            "target_branch": "main",
            "commit_message": "Initial commit",
            "author": {
                "name": "Your Name",
                "email": "you@example.com"
            },
        })
        .add_file_from_string("README.md", "# My Project\n\nWelcome!")
        .send()
    )

    print(f"Commit SHA: {result['commit_sha']}")

# Run the example
asyncio.run(main())
```

## Reading Repository Data

```python
async def read_data():
    storage = GitStorage({"name": "your-name", "key": "your-key"})
    repo = await storage.find_one({"id": "repo-id"})

    # List files
    files = await repo.list_files()
    print("Files:", files["paths"])

    # List commits
    commits = await repo.list_commits({"limit": 10})
    for commit in commits["commits"]:
        print(f"{commit['sha'][:7]} - {commit['message']}")

    # Get file content
    response = await repo.get_file_stream({"path": "README.md"})
    content = await response.aread()
    print(content.decode())

asyncio.run(read_data())
```

## Making Changes

```python
async def make_changes():
    storage = GitStorage({"name": "your-name", "key": "your-key"})
    repo = await storage.find_one({"id": "repo-id"})

    # Update and delete files in one commit
    result = await (
        repo.create_commit({
            "target_branch": "main",
            "commit_message": "Update documentation",
            "author": {"name": "Bot", "email": "bot@example.com"},
        })
        .add_file_from_string("docs/guide.md", "# Guide\n\nNew content")
        .add_file_from_string("README.md", "# Updated\n\nRevised readme")
        .delete_path("old-file.txt")
        .send()
    )

    print(f"New commit: {result['commit_sha']}")

asyncio.run(make_changes())
```

### Applying a Diff Directly

If you already have a unified diff (for example, generated by `git diff`), you
can apply it without building file operations manually:

```python
async def apply_diff():
    storage = GitStorage({"name": "your-name", "key": "your-key"})
    repo = await storage.find_one({"id": "repo-id"})

    diff_text = """\
--- a/README.md
+++ b/README.md
@@
-Old line
+New line
"""

    result = await repo.create_commit_from_diff(
        target_branch="main",
        commit_message="Apply upstream changes",
        diff=diff_text,
        author={"name": "Automation", "email": "bot@example.com"},
        base_branch="main",  # optional, matches create_commit options
    )

    print(f"Updated commit: {result['commit_sha']}")

asyncio.run(apply_diff())
```

## Using with Git CLI

Once you have the remote URL, you can use it with standard Git commands:

```bash
# Clone the repository
git clone <remote-url>

# Or add as a remote to existing repo
git remote add origin <remote-url>

# Push changes
git push origin main
```

## Generating JWT Tokens Manually

For advanced use cases, you can generate JWT tokens directly:

```python
from pierre_storage import generate_jwt

# Read your private key
with open("path/to/key.pem", "r") as f:
    private_key = f.read()

# Generate a JWT token
token = generate_jwt(
    key_pem=private_key,
    issuer="your-name",
    repo_id="your-repo-id",
    scopes=["git:write", "git:read"],  # Optional
    ttl=3600,  # 1 hour, optional
)

# Use in Git URL
git_url = f"https://t:{token}@your-name.code.storage/your-repo-id.git"
print(f"Git URL: {git_url}")
```

This is useful when you need:

- Custom token expiration times
- Specific permission scopes
- Tokens for external tools
- Fine-grained access control

## Environment Configuration

For production use, configure the SDK with your environment:

```python
storage = GitStorage({
    "name": "your-company",
    "key": your_private_key,
    "api_base_url": "https://api.code.storage",
    "storage_base_url": "code.storage",
})
```

## Error Handling

```python
from pierre_storage import ApiError, RefUpdateError

try:
    repo = await storage.create_repo({"id": "my-repo"})
except ApiError as e:
    if e.status_code == 409:
        print("Repository already exists")
        repo = await storage.find_one({"id": "my-repo"})
    else:
        raise

try:
    result = await builder.send()
except RefUpdateError as e:
    print(f"Commit failed: {e.message}")
    print(f"Reason: {e.reason}")
    # Handle conflict, retry, or notify user
```

## Next Steps

- Read the [full documentation](README.md) for detailed API reference
- Check out [webhook validation](README.md#webhook-validation) for integrating
  with events
- See [examples/](examples/) for more complex use cases

## Need Help?

- Check the [README](README.md) for comprehensive documentation
- Open an issue on GitHub
- Contact support at support@pierre.io
